version: '3.8'
services:
  redis-cache:
    image: redis:6-alpine
    command: ["redis-server", "--port", "6379"]
    volumes:
      - redis_cache_data:/data
    networks:
      - ail-net
    restart: unless-stopped

  redis-log:
    image: redis:6-alpine
    command: ["redis-server", "--port", "6380"]
    volumes:
      - redis_log_data:/data
    networks:
      - ail-net
    restart: unless-stopped

  redis-work:
    image: redis:6-alpine
    command: ["redis-server", "--port", "6381"]
    volumes:
      - redis_work_data:/data
    networks:
      - ail-net
    restart: unless-stopped

  kvrocks:
    image: kvrocks/kvrocks:latest
    command: ["./bin/kvrocks", "-c", "/opt/kvrocks/kvrocks.conf"]
    volumes:
      - ./data/kvrocks:/opt/kvrocks/data
      - ./kvrocks.conf:/opt/kvrocks/kvrocks.conf
    networks:
      - ail-net
    restart: unless-stopped

  # Tor proxy for Lacus .onion crawling
  tor_proxy:
    image: osminogin/tor-simple:latest
    networks:
      - ail-net
    restart: unless-stopped

  # Valkey for Lacus (Redis alternative)
  valkey:
    image: valkey/valkey:8.0
    command: ["valkey-server", "--port", "6385"]
    volumes:
      - valkey_data:/data
    networks:
      - ail-net
    restart: unless-stopped

  # Lacus crawler service
  lacus:
    build:
      context: .
      dockerfile: Dockerfile.lacus
    environment:
      LACUS_HOME: /opt/lacus
      PYTHONPATH: /opt/lacus
    ports:
      - "7100:7100"    
    volumes:
      - ./data/lacus:/opt/lacus/data
      - ./data/logs:/opt/lacus/logs
      - ./configs/lacus/docker.generic.json:/opt/lacus/config/generic.json
    networks:
      - ail-net
    depends_on:
      - valkey
      - tor_proxy
    restart: no  
  init-lacus-url:
    image: redis:6-alpine
    depends_on:
      - kvrocks
    entrypoint: ["sh", "-c", "redis-cli -h kvrocks -p 6383 HSET crawler:lacus url http://lacus:7100"]
    networks:
      - ail-net
    restart: "no"

  ail-app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      FLASK_HOST: 0.0.0.0
      FLASK_PORT: 7000
      AIL_HOME: /opt/ail
      AIL_BIN: /opt/ail/bin
      AIL_FLASK: /opt/ail/var/www
    ports:
      - "7000:7000"
    volumes:
      - ./data/pastes:/opt/ail/PASTES
      - ./data/screenshots:/opt/ail/CRAWLED_SCREENSHOT
      - ./data/images:/opt/ail/IMAGES
      - ./data/logs:/opt/ail/logs
      - ./data/blooms:/opt/ail/Blooms
      - ./data/hashs:/opt/ail/HASHS
      - ./configs:/opt/ail/configs
      - ./bin:/opt/ail/bin
    networks:
      - ail-net
    depends_on:
      - redis-cache
      - redis-log
      - redis-work
      - kvrocks
      - lacus
    restart: no

volumes:
  redis_cache_data:
  redis_log_data:
  redis_work_data:
  valkey_data:

networks:
  ail-net:
    driver: bridge
